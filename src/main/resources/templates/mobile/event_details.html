<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{mobile/layout :: layout(#{event.details}, ~{::section})}">
<section>
    <div style="margin-bottom: 1rem;">
        <a th:href="@{/}" style="color: var(--text-secondary);">&larr; <span th:text="#{app.back_dashboard}">Torna alla
                Dashboard</span></a>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div th:replace="~{mobile/fragments/event-header :: eventHeader}"></div>

    <!-- Error Message Display -->
    <div th:if="${errorMessage}"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        style="background-color: #fee2e2; color: #991b1b; padding: 1rem; border: 1px solid #f87171; margin-bottom: 1.5rem;">
        <strong>Errore:</strong> <span th:text="${errorMessage}">Messaggio di errore</span>
    </div>

    <div th:replace="~{mobile/fragments/event-actions :: eventActions}"></div>



    <style>
        /* Loaded via Tailwind now */

        /* Loading Spinner Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.7);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- Add Proposal Form (Hidden by default) -->
    <div id="add-proposal-form"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        style="display: none; background: var(--surface); border: 1px dashed var(--border);">
        <h4 th:text="#{event.proposals.add}">Nuova Proposta</h4>

        <div th:if="${not #lists.isEmpty(recentProposals)}" style="margin-bottom: 1rem;">
            <label for="proposal-suggestion" style="display: block; font-size: 0.9rem; margin-bottom: 0.25rem;"
                th:text="#{event.suggestions.label}">Suggerimenti Recenti</label>
            <select id="proposal-suggestion"
                class="form-control mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                onchange="fillProposalForm(this)">
                <option value="" th:text="#{event.suggestions.select}">-- Seleziona --</option>
                <option th:each="p : ${recentProposals}" th:value="${p.location}" th:data-address="${p.address}"
                    th:data-description="${p.description}"
                    th:text="${p.location} + (${p.address} ? ' (' + ${p.address} + ')' : '') + ' - ðŸ‘ ' + ${p.totalLikes} + ' | ðŸ‘Ž ' + ${p.totalDislikes}">
                    Luogo
                </option>
            </select>
        </div>

        <form th:action="@{/events/{id}/add-proposal(id=${event.id})}" method="post"
            onsubmit="handleAjaxForm(event, 'add-proposal-form')">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label th:text="#{event.date}">Data e Ora</label>
                    <div id="date-inputs-container">
                        <div class="date-input-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="datetime-local" name="dateOption" required style="flex-grow: 1;">
                            <button type="button"
                                class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                                onclick="addDateInput()" title="Aggiungi altra data">+</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="location" th:text="#{event.location}">Luogo</label>
                    <input type="text" id="location" name="location" th:placeholder="#{create.placeholder.location}"
                        required>
                </div>
            </div>
            <div class="form-group">
                <label for="address" th:text="#{event.address}">Indirizzo (per Mappa)</label>
                <input type="text" id="address" name="address" th:placeholder="#{create.placeholder.address}" required>
            </div>
            <div class="form-group">
                <label for="propDescription" th:text="#{dashboard.description}">Descrizione</label>
                <input type="text" id="propDescription" name="description"
                    th:placeholder="#{create.placeholder.description}">
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit"
                    class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    th:text="#{app.add}">Aggiungi</button>
                <button type="button" onclick="document.getElementById('add-proposal-form').style.display='none'"
                    class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    th:text="#{app.cancel}">Annulla</button>
            </div>
        </form>
    </div>

    <div th:replace="~{mobile/fragments/event-proposals :: proposalList}"></div>
    </div>
    </div>
    <!-- Chat Section -->
    <div class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        style="margin-top: 2rem;">
        <h3 th:text="#{event.chat}">Chat Evento</h3>
        <div id="chat-container"
            style="height: 300px; overflow-y: auto; border: 1px solid var(--border); padding: 1rem; margin-bottom: 1rem; background: var(--surface); display: flex; flex-direction: column;">
            <div th:each="msg : ${chatMessages}" style="margin-bottom: 0.5rem;">
                <strong th:text="${msg.sender.username}">User</strong> <span
                    style="font-size: 0.8em; color: var(--text-secondary);"
                    th:text="${#temporals.format(msg.timestamp, 'dd MMM HH:mm')}">Time</span>:
                <span th:text="${msg.content}">Content</span>
            </div>
        </div>
        <form id="chat-form" onsubmit="sendChatMessage(event)" style="display: flex; gap: 0.5rem;">

            <input type="text" id="chat-input"
                class="form-control mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm dark:bg-gray-700 dark:text-white"
                th:placeholder="#{event.chat.placeholder}" required style="flex-grow: 1;" autocomplete="off">
            <button type="submit"
                class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                th:text="#{event.chat.send}">Invia</button>
        </form>
    </div>

    <!-- Manage Participants Modal (Moved to bottom to avoid nesting issues) -->
    <div id="manage-participants-modal"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        th:if="${isOrganizer}"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 800px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border);">
        <h4 style="margin-bottom: 1rem;"
            th:text="${event.status.name() == 'OPEN'} ? #{participants.modal.title} : #{event.participants}">Gestisci
            Partecipanti</h4>

        <form th:action="@{/events/{id}/update-participants(id=${event.id})}" method="post" id="participantsForm"
            onsubmit="handleParticipantsSubmit(event)">
            <!-- Dual List Container -->
            <div th:replace="~{mobile/fragments/event-participants :: participantLists}"></div>

            <!-- Hidden inputs container for submission -->
            <div id="hidden-inputs-container"></div>

            <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                <button type="button"
                    onclick="document.getElementById('manage-participants-modal').style.display='none'"
                    class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    th:text="#{app.close}">Chiudi</button>
                <button th:if="${event.status?.name() == 'OPEN'}" type="submit"
                    class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    th:text="#{app.save}">Salva</button>
            </div>
        </form>
    </div>

    <!-- Add Central Proposal Modal -->
    <div id="add-central-proposal-modal"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 90%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border);">
        <h4 style="margin-bottom: 1rem;" th:text="#{event.actions.add_central_proposal}">Aggiungi Proposta Centrale</h4>

        <form th:action="@{/events/{id}/add-central-proposal(id=${event.id})}" method="post"
            onsubmit="handleAjaxForm(event, 'add-central-proposal-modal')">
            <div class="form-group">
                <label for="central-proposal-date" th:text="#{event.date}">Data</label>
                <input type="datetime-local" id="central-proposal-date" name="dateOption" required
                    class="form-control mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm dark:bg-gray-700 dark:text-white">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                <button type="button"
                    onclick="document.getElementById('add-central-proposal-modal').style.display='none'"
                    class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    th:text="#{app.cancel}">Annulla</button>
                <button type="submit"
                    class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-secondary-600 hover:bg-secondary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-500"
                    th:text="#{app.add}">Aggiungi</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var eventId = /*[[${event.id}]]*/ '0';
        /*]]>*/

        var socket = new WebSocket(((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/ws");
        var stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            function updateFragment(url, elementId) {
                var el = document.getElementById(elementId);
                if (!el) return;
                fetch(url)
                    .then(response => {
                        if (response.status === 403 || response.redirected) {
                            window.location.href = '/';
                            return null;
                        }
                        return response.text();
                    })
                    .then(html => {
                        if (html) el.outerHTML = html;
                    })
                    .catch(console.error);
            }

            function refreshAll() {
                // Generic fetcher that handles redirects
                const fetchFragment = (url) => fetch(url).then(response => {
                    if (response.status === 403 || response.redirected) {
                        window.location.href = '/';
                        throw new Error("Redirected");
                    }
                    return response.text();
                });

                // Spinner is managed by the initiator (handleAjaxForm). Passive updates shouldn't block UI.
                Promise.all([
                    fetchFragment('/events/' + eventId + '/fragments/header'),
                    fetchFragment('/events/' + eventId + '/fragments/actions'),
                    fetchFragment('/events/' + eventId + '/fragments/proposals'),
                    fetchFragment('/events/' + eventId + '/fragments/participants')
                ]).then(values => {
                    var header = document.getElementById('event-header-card'); if (header) header.outerHTML = values[0];
                    var actions = document.getElementById('event-action-bar'); if (actions) actions.outerHTML = values[1];
                    var proposals = document.getElementById('proposal-list-container'); if (proposals) proposals.outerHTML = values[2];
                    var participants = document.getElementById('participant-lists-container'); if (participants) participants.outerHTML = values[3];
                    document.getElementById('loading-overlay').style.display = 'none';
                }).catch(e => {
                    if (e.message !== "Redirected") console.error(e);
                    document.getElementById('loading-overlay').style.display = 'none';
                });
            }

            stompClient.subscribe('/topic/events/' + eventId, function (message) {
                if (message.body === 'update') {
                    refreshAll();
                } else if (message.body === 'update-participants') {
                    fetchFragment('/events/' + eventId + '/fragments/participants')
                        .then(html => {
                            var participants = document.getElementById('participant-lists-container');
                            if (participants) participants.outerHTML = html;
                        })
                        .catch(console.error);
                } else if (message.body === 'DELETED') {
                    alert('L\'evento Ã¨ stato cancellato dall\'organizzatore.');
                    window.location.href = '/';
                }
            });
            stompClient.subscribe('/user/topic/dashboard-updates', function (message) {
                if (message.body === 'REFRESH') {
                    refreshAll();
                }
            });
            stompClient.subscribe('/topic/events/' + eventId + '/chat', function (message) {
                var msg = JSON.parse(message.body);
                appendChatMessage(msg);
            });
        });

        // Scroll to bottom on load
        var chatContainer = document.getElementById('chat-container');
        if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;

        function appendChatMessage(msg) {
            var container = document.getElementById('chat-container');
            var div = document.createElement('div');
            div.style.marginBottom = '0.5rem';
            div.innerHTML = '<strong>' + msg.sender + '</strong> <span style="font-size: 0.8em; color: var(--text-secondary);">' + msg.time + '</span>: <span>' + msg.content + '</span>';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function sendChatMessage(e) {
            e.preventDefault();
            var input = document.getElementById('chat-input');
            var content = input.value.trim();
            if (!content) return;



            fetch('/events/' + eventId + '/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',

                },
                body: new URLSearchParams({ 'content': content })
            }).then(response => {
                if (response.ok) {
                    input.value = '';
                } else {
                    console.error('Error sending message');
                }
            });
        }

        function fillProposalForm(selectElement) {
            var selectedOption = selectElement.options[selectElement.selectedIndex];
            var locInput = document.getElementById('location');
            var addrInput = document.getElementById('address');
            var descInput = document.getElementById('propDescription');

            if (selectedOption.value) {
                locInput.value = selectedOption.value;
                addrInput.value = selectedOption.getAttribute('data-address') || '';
                descInput.value = selectedOption.getAttribute('data-description') || '';

                // Make read-only
                locInput.readOnly = true;
                addrInput.readOnly = true;
                descInput.readOnly = true;

                // Visual feedback (optional but good)
                locInput.style.backgroundColor = 'var(--bg-secondary)';
                addrInput.style.backgroundColor = 'var(--bg-secondary)';
                descInput.style.backgroundColor = 'var(--bg-secondary)';
            } else {
                // Clear and make editable
                locInput.value = '';
                addrInput.value = '';
                descInput.value = '';

                locInput.readOnly = false;
                addrInput.readOnly = false;
                descInput.readOnly = false;

                locInput.style.backgroundColor = '';
                addrInput.style.backgroundColor = '';
                descInput.style.backgroundColor = '';
            }
        }

        // Dual List Logic
        function toggleSelection(element) {
            element.classList.toggle('selected'); // Keep for logic if needed, but styling via class below
            element.classList.toggle('bg-primary-600');
            element.classList.toggle('text-white');
            element.classList.toggle('hover:bg-gray-100'); // Toggle off hover
        }

        function moveAllRight() {
            const leftList = document.getElementById('left-list');
            const rightList = document.getElementById('right-list');
            while (leftList.firstChild) {
                let item = leftList.firstChild;
                if (item.classList) item.classList.remove('selected');
                rightList.appendChild(item);
            }
        }

        function moveSelectedRight() {
            const leftList = document.getElementById('left-list');
            const rightList = document.getElementById('right-list');
            const selected = leftList.querySelectorAll('.selected');
            selected.forEach(item => {
                item.classList.remove('selected');
                rightList.appendChild(item);
            });
        }

        function moveSelectedLeft() {
            const leftList = document.getElementById('left-list');
            const rightList = document.getElementById('right-list');
            const selected = rightList.querySelectorAll('.selected');
            selected.forEach(item => {
                item.classList.remove('selected');
                leftList.appendChild(item);
            });
        }

        function moveAllLeft() {
            const leftList = document.getElementById('left-list');
            const rightList = document.getElementById('right-list');
            while (rightList.firstChild) {
                let item = rightList.firstChild;
                if (item.classList) item.classList.remove('selected');
                leftList.appendChild(item);
            }
        }

        function prepareParticipantsSubmission() {
            const container = document.getElementById('hidden-inputs-container');
            container.innerHTML = ''; // Clear previous
            const rightList = document.getElementById('right-list');
            const items = rightList.querySelectorAll('.user-item');
            items.forEach(item => {
                const id = item.getAttribute('data-id');
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'participantIds';
                input.value = id;
                container.appendChild(input);
            });
        }

        function handleAjaxForm(event, hideModalId) {
            event.preventDefault();
            document.getElementById('loading-overlay').style.display = 'flex';

            var form = event.target;
            var formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                // If it's a redirect or success, we just wait for socket or hide manually
                // But for good UX, we keep spinner until socket updates or if error we hide it.
                if (!response.ok && !response.redirected) {
                    console.error('Action failed');
                    alert('Operazione fallita!');
                    document.getElementById('loading-overlay').style.display = 'none';
                }
                // If success, we can hide the modal immediately if specified
                if (hideModalId) {
                    document.getElementById(hideModalId).style.display = 'none';
                }
                // Don't hide overlay yet, wait for WebSocket 'update' to hide it OR set a timeout fallback
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 2000); // Fallback if WS fails
            }).catch(e => {
                console.error(e);
                document.getElementById('loading-overlay').style.display = 'none';
            });
        }

        // Modified Participant Handler to use spinner
        function handleParticipantsSubmit(event) {
            event.preventDefault();
            prepareParticipantsSubmission();
            document.getElementById('loading-overlay').style.display = 'flex';
            var form = event.target;
            var formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok || response.redirected) {
                    document.getElementById('manage-participants-modal').style.display = 'none';
                    // Spinner hides via WS update or timeout
                    setTimeout(() => {
                        document.getElementById('loading-overlay').style.display = 'none';
                    }, 2000);
                } else {
                    alert('Errore durante il salvataggio dei partecipanti.');
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            }).catch(console.error);
        }

        // ajaxVote is replaced by generic handleAjaxForm but kept if needed for specific logic? 
        // No, replaced in HTML so this can be removed or aliased.
        // Date Input Logic
        function addDateInput() {
            var container = document.getElementById('date-inputs-container');
            var div = document.createElement('div');
            div.className = 'date-input-row';
            div.style = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            div.innerHTML = '<input type="datetime-local" name="dateOption" required style="flex-grow: 1;"> <button type="button" class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" onclick="this.parentElement.remove()" title="Rimuovi">-</button>';
            container.appendChild(div);
        }

        function handleAjaxForm(event) { handleAjaxForm(event); }
        function toggleDateAddForm(btn) {
            var formDiv = btn.parentElement.nextElementSibling;
            if (formDiv.style.display === 'none') {
                formDiv.style.display = 'block';
            } else {
                formDiv.style.display = 'none';
            }
        }

        // Confirmation Modal Logic
        let formToSubmit = null;

        function openConfirmationModal(form) {
            formToSubmit = form;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            formToSubmit = null;
        }

        function confirmAction() {
            if (formToSubmit) {
                formToSubmit.requestSubmit();
                closeConfirmationModal();
            }
        }
    </script>

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="modal"
        style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
            style="margin: auto; padding: 1rem; width: 90%; max-width: 400px; position: relative;">
            <h3 th:text="#{event.modal.confirm_title}" style="margin-top: 0; font-size: 1.1rem;">Conferma</h3>
            <p th:text="#{event.modal.confirm_body}">Sei sicuro?</p>
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
                <button
                    class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    onclick="closeConfirmationModal()" th:text="#{app.cancel}">Annulla</button>
                <button
                    class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    onclick="confirmAction()" th:text="#{event.modal.confirm}">Conferma</button>
            </div>
        </div>
    </div>
</section>

</html>