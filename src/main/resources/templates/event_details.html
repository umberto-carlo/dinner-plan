<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout('Dettagli Evento', ~{::section})}">
<section>
    <div style="margin-bottom: 1rem;">
        <a th:href="@{/}" style="color: var(--text-secondary);">&larr; Torna alla Dashboard</a>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h2 th:text="${event.title}" style="margin-bottom: 0.5rem;">Event Title</h2>
                <p th:text="${event.description}" style="color: var(--text-secondary); margin-bottom: 1rem;">Description
                </p>
                <div class="meta">
                    Organizzatore: <span th:text="${event.organizer.username}">User</span>
                    | Scadenza: <span th:text="${#temporals.format(event.deadline, 'dd MMM yyyy HH:mm')}">Date</span>
                </div>
            </div>
            <div>
                <span
                    style="padding: 0.25rem 0.75rem; background: #e2e8f0; border-radius: 999px; font-size: 0.875rem; font-weight: 500;"
                    th:text="${event.status}">OPEN</span>
            </div>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3>Proposte</h3>
        <!-- Only Organizer can add proposals AND event must be OPEN -->
        <button th:if="${isOrganizer and event.status.name() == 'OPEN'}"
            onclick="document.getElementById('add-proposal-form').style.display='block'" class="btn">
            Aggiungi Proposta
        </button>
    </div>

    <!-- Add Proposal Form (Hidden by default) -->
    <div id="add-proposal-form" class="card"
        style="display: none; background: #f8fafc; border: 1px dashed var(--border);">
        <h4>Nuova Proposta</h4>
        <h4>Nuova Proposta</h4>

        <div th:if="${not #lists.isEmpty(recentProposals)}" style="margin-bottom: 1rem;">
            <label for="proposal-suggestion"
                style="display: block; font-size: 0.9rem; margin-bottom: 0.25rem;">Suggerimenti Recenti (clicca per
                compilare)</label>
            <select id="proposal-suggestion" class="form-control" onchange="fillProposalForm(this)">
                <option value="">-- Seleziona un luogo recente --</option>
                <option th:each="p : ${recentProposals}" th:value="${p.location}" th:data-address="${p.address}"
                    th:data-description="${p.description}"
                    th:text="${p.location} + (${p.address} ? ' (' + ${p.address} + ')' : '')">
                    Luogo
                </option>
            </select>
        </div>

        <form th:action="@{/events/{id}/add-proposal(id=${event.id})}" method="post">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="dateOption">Data e Ora</label>
                    <input type="datetime-local" id="dateOption" name="dateOption" required>
                </div>
                <div class="form-group">
                    <label for="location">Luogo</label>
                    <input type="text" id="location" name="location" placeholder="es. Pizzeria da Michele" required>
                </div>
            </div>
            <div class="form-group">
                <label for="address">Indirizzo (per Mappa)</label>
                <input type="text" id="address" name="address" placeholder="es. Via dei Tribunali 32, Napoli" required>
            </div>
            <div class="form-group">
                <label for="propDescription">Descrizione</label>
                <input type="text" id="propDescription" name="description" placeholder="Dettagli opzionali">
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" class="btn">Aggiungi</button>
                <button type="button" onclick="document.getElementById('add-proposal-form').style.display='none'"
                    class="btn btn-secondary">Annulla</button>
            </div>
        </form>
    </div>

    <div th:if="${event.proposals.empty}" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
        Nessuna proposta aggiunta ancora.
    </div>

    <div th:each="proposal : ${sortedProposals}" class="card proposal-card"
        style="background: white; border-left: 4px solid var(--primary-color);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="flex-grow: 1;">
                <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.25rem;">
                    <span th:text="${proposal.location}">Location</span>
                    <span style="font-weight: 400; color: var(--text-secondary);"> @ </span>
                    <span th:text="${#temporals.format(proposal.dateOption, 'dd MMM yyyy HH:mm')}">Date</span>
                </div>
                <div th:if="${proposal.address}"
                    style="font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.5rem;">
                    üìç <span th:text="${proposal.address}">Indirizzo</span>
                    <div
                        style="margin-top: 0.5rem; border-radius: 0.5rem; overflow: hidden; height: 150px; width: 100%; max-width: 400px;">
                        <iframe width="100%" height="150" style="border:0" loading="lazy" allowfullscreen
                            th:src="'https://maps.google.com/maps?q=' + ${proposal.address} + '&t=&z=15&ie=UTF8&iwloc=&output=embed'">
                        </iframe>
                    </div>
                </div>
                <div th:if="${proposal.description}" th:text="${proposal.description}"
                    style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;"></div>

                <!-- Winner Badge -->
                <div th:if="${event.status.name() == 'DECIDED' and event.selectedProposal != null and event.selectedProposal.id == proposal.id}"
                    style="margin-bottom: 0.5rem; display: inline-block; background: #FFD700; color: #000; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.85rem;">
                    üèÜ PROPOSTA SCELTA
                </div>

                <!-- Organizer Select Button -->
                <div th:if="${isOrganizer and event.status.name() == 'OPEN'}" style="margin-bottom: 0.5rem;">
                    <form th:action="@{/events/{id}/select-proposal(id=${event.id}, proposalId=${proposal.id})}"
                        method="post" style="display:inline;">
                        <button type="submit" class="btn btn-secondary" style="font-size: 0.8rem; padding: 2px 8px;"
                            onclick="return confirm('Sei sicuro di voler scegliere questa proposta come definitiva? L\'evento verr√† chiuso.');">
                            Scegli come definitiva
                        </button>
                    </form>
                </div>

                <!-- Vote Count -->
                <div style="font-size: 0.875rem; font-weight: 500; color: var(--text-primary); margin-top: 0.5rem;">
                    Voti: <span th:text="${proposal.votes.size()}">0</span>
                </div>

                <!-- Voter List (Organizer Only) -->
                <div th:if="${isOrganizer}"
                    style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                    <strong>Partecipanti:</strong>
                    <span th:each="vote, iterStat : ${proposal.votes}">
                        <span th:text="${vote.user.username}">User</span><span th:if="${!iterStat.last}">, </span>
                    </span>
                    <span th:if="${proposal.votes.empty}">Nessuno</span>
                </div>
            </div>

            <div th:if="${currentUser != null}" style="text-align: right; min-width: 120px;">
                <!-- Vote Button / Indicator -->
                <div th:if="${#lists.contains(votedProposalIds, proposal.id)}"
                    style="color: var(--success); font-weight: 600; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.25rem;">&#10003;</span> Il tuo voto
                </div>

                <div th:if="${event.status.name() == 'OPEN'}">
                    <form th:action="@{/proposals/{id}/vote(id=${proposal.id}, eventId=${event.id})}" method="post">
                        <button type="submit"
                            th:class="${#lists.contains(votedProposalIds, proposal.id)} ? 'btn btn-red' : 'btn btn-secondary'"
                            th:text="${#lists.contains(votedProposalIds, proposal.id)} ? 'Rimuovi Voto' : 'Vota'">
                            Vota
                        </button>
                    </form>
                </div>
                <!-- Note: The Controller "castVote" currently adds a vote. It doesn't toggle. 
                     The prompt didn't strictly ask for remove vote, but logical behavior for "Vota" when already voted is either disable or toggle. 
                     Given constraint "vote for one or more", adding duplicates is blocked by DB.
                     I'll stick to "Vota" button. The visual indicator above confirms the vote. 
                     Attempting to vote again will likely error or be ignored in backend (depending on implementation - currently it just saves, which might throw exception on UniqueConstraint). 
                     For this iteration, showing "Il tuo voto" is key validation. Handling re-vote gracefully is bonus. 
                -->
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        var eventId = /*[[${event.id}]]*/ '0';
        /*]]>*/

        var socket = new SockJS('/ws');
        var stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/topic/events/' + eventId, function (message) {
                if (message.body === 'update') {
                    location.reload();
                }
            });
        });

        function fillProposalForm(selectElement) {
            var selectedOption = selectElement.options[selectElement.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('location').value = selectedOption.value;
                document.getElementById('address').value = selectedOption.getAttribute('data-address') || '';
                document.getElementById('propDescription').value = selectedOption.getAttribute('data-description') || '';
            }
        }
    </script>
</section>

</html>