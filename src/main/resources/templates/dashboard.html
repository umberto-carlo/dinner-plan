<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(#{app.title}, ~{::section})}">
<section>
    <div id="dashboard-content" th:fragment="dashboardContent">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 th:text="#{app.title}">Prossime Cene</h2>
            <a th:if="${isOrganizer}" th:href="@{/events/create}" class="btn" th:text="#{dashboard.create}">Crea Nuovo
                Evento</a>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('events')" id="btn-events"
                th:text="#{dashboard.tab.events}">Eventi</button>
            <button class="tab-btn" onclick="switchTab('proposals')" id="btn-proposals"
                th:text="#{dashboard.tab.proposals}">Classifica Proposte</button>
        </div>

        <div id="tab-events" class="tab-content active">
            <div th:if="${events.empty}" class="card">
                <p th:text="#{dashboard.empty}">Nessun evento pianificato al momento.</p>
            </div>

            <div th:each="event : ${events}" class="card event-item"
                th:styleappend="${event.status.name() == 'OPEN' ? 'border-left: 5px solid var(--success);' : 'border-left: 5px solid var(--error);'}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div class="event-title" th:text="${event.title}">Cena Team</div>
                        <div style="margin-bottom: 0.5rem;" th:text="${event.description}">Descrizione</div>
                        <div class="meta">
                            <span th:text="#{event.by}">Organizzatore:</span> <span
                                th:text="${event.organizer.username}">User</span>
                            | <span th:text="#{event.status}">Stato:</span> <span th:text="${event.status}">OPEN</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="meta" style="margin-bottom: 0.5rem;">
                            <span th:text="#{event.deadline}">Scadenza:</span> <span
                                th:text="${#temporals.format(event.deadline, 'dd MMM yyyy HH:mm')}">Date</span>
                        </div>
                        <a th:href="@{/events/{id}(id=${event.id})}" class="btn btn-secondary"
                            th:text="#{dashboard.view}">Dettagli</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-proposals" class="tab-content">
            <div th:if="${rankedProposals.empty}" class="card">
                <p th:text="#{dashboard.empty_proposals}">Nessuna proposta registrata al momento.</p>
            </div>

            <form th:if="${!rankedProposals.empty}" th:action="@{/events/prepare-smart}" method="post">
                <div style="margin-bottom: 1rem; text-align: right;" th:if="${isOrganizer}">
                    <button type="submit" class="btn" th:text="#{dashboard.create_smart}">Crea Evento con
                        Selezionati</button>
                </div>

                <div th:each="prop : ${rankedProposals}" class="rank-item">
                    <div style="margin-right: 1rem;" th:if="${isOrganizer}">
                        <input type="checkbox" name="selectedProposals" th:value="${prop.encodedData}"
                            style="width: 20px; height: 20px;">
                    </div>

                    <div class="rank-score">
                        <span th:text="${prop.totalLikes}">0</span>
                        <i style="color: var(--success); font-size: 1rem;">&#9650;</i>
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: bold; font-size: 1.1rem;" th:text="${prop.location}">Location</div>
                        <div style="color: var(--text-secondary);" th:text="${prop.address}">Address</div>
                        <div style="font-size: 0.9rem; margin-top: 0.2rem;" th:text="${prop.description}"></div>
                    </div>
                    <div style="text-align: right; min-width: 100px;">
                        <div class="meta"><span th:text="#{dashboard.used}">Usato</span> <span
                                th:text="${prop.usageCount}">0</span> <span th:text="#{dashboard.times}">volte</span>
                        </div>
                        <div class="meta" style="color: var(--error);">
                            <span th:text="${prop.totalDislikes}">0</span> &#9660;
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Init state
        if (!localStorage.getItem('activeDashboardTab')) {
            localStorage.setItem('activeDashboardTab', 'events');
        }

        function switchTab(tabName) {
            localStorage.setItem('activeDashboardTab', tabName);
            applyTabState();
        }

        function applyTabState() {
            const tabName = localStorage.getItem('activeDashboardTab') || 'events';

            // Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById('btn-' + tabName);
            if (activeBtn) activeBtn.classList.add('active');

            // Content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const activeContent = document.getElementById('tab-' + tabName);
            if (activeContent) activeContent.classList.add('active');
        }

        // Apply on load
        applyTabState();

        // WebSocket
        var socket = new WebSocket(((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/ws");
        var stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            function refreshEventList() {
                fetch('/fragments/dashboard')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('dashboard-content').outerHTML = html;
                        applyTabState(); // Re-apply state after refresh
                    })
                    .catch(console.error);
            }

            stompClient.subscribe('/topic/events', function (message) {
                if (message.body === 'update') {
                    refreshEventList();
                }
            });
            stompClient.subscribe('/user/topic/dashboard-updates', function (message) {
                if (message.body === 'REFRESH') {
                    refreshEventList();
                }
            });
        });
    </script>
</section>

</html>