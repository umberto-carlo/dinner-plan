<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{mobile/layout :: layout(#{app.title}, ~{::section})}">
<section>
    <div id="dashboard-content" th:fragment="dashboardContent">
        <div class="bg-blue-600 text-white p-2 text-center text-xs mb-2"
            style="background: #e0f2fe; color: #0284c7; padding: 0.5rem; border-radius: 4px; border: 1px solid #0284c7; margin-bottom: 1rem; text-align: center; font-weight: bold;"
            th:text="#{mobile.optimized_view}">
            üì± Mobile Optimized View
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 th:text="#{dashboard.header}" style="font-size: 1.25rem;">Prossime Cene</h2>
        </div>

        <style>
            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
                animation: fadeIn 0.3s;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }

            /* Active Tab Styling mimicking Tailwind */
            .tab-btn.active {
                background-color: white;
                color: #2563eb;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            :root[class~="dark"] .tab-btn.active {
                background-color: #1f2937;
                color: #60a5fa;
            }
        </style>

        <div class="tab-nav flex space-x-2 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg mb-4">
            <button
                class="tab-btn active flex-1 py-1.5 px-3 text-center text-xs font-medium rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-all focus:outline-none"
                onclick="switchTab('events')" id="btn-events" th:text="#{dashboard.tab.events}">Eventi</button>
            <button
                class="tab-btn flex-1 py-1.5 px-3 text-center text-xs font-medium rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-all focus:outline-none"
                onclick="switchTab('proposals')" id="btn-proposals"
                th:text="#{dashboard.tab.proposals}">Classifica</button>
            <button
                class="tab-btn flex-1 py-1.5 px-3 text-center text-xs font-medium rounded-md text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-all focus:outline-none"
                onclick="switchTab('calendar')" id="btn-calendar"
                th:text="#{dashboard.tab.calendar}">Calendario</button>
        </div>

        <div id="tab-events" class="tab-content active">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;" th:if="${isOrganizer}">
                <a th:href="@{/events/create}"
                    class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    th:text="#{dashboard.create}">Crea Nuovo Evento</a>
            </div>

            <div th:if="${events.empty}"
                class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700">
                <p th:text="#{dashboard.empty}">Nessun evento pianificato al momento.</p>
            </div>

            <div th:each="event : ${events}"
                class="card event-item bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border-l-4"
                th:if="${event != null}"
                th:classappend="${event.status?.name() == 'OPEN'} ? 'border-green-500 dark:border-green-400' : 'border-red-500 dark:border-red-400'">
                <div class="flex flex-col gap-2">
                    <div>
                        <div class="text-lg font-bold text-gray-900 dark:text-white" th:text="${event.title}">Cena Team
                        </div>
                        <div class="mb-2 text-sm text-gray-600 dark:text-gray-300" th:text="${event.description}">
                            Descrizione</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">
                            <span th:text="${event.organizer.username}">User</span>
                            | <span th:text="#{${'event.status.' + event.status}}">OPEN</span>
                        </div>
                    </div>
                    <div class="border-t border-gray-100 dark:border-gray-700 pt-2 flex justify-between items-center">
                        <div class="text-sm font-medium text-gray-500 dark:text-gray-400">
                            <span th:text="${#temporals.format(event.deadline, 'dd MMM HH:mm')}">Date</span>
                        </div>
                        <a th:href="@{/events/{id}(id=${event.id})}"
                            class="inline-flex items-center justify-center px-3 py-1 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                            th:text="#{dashboard.view}">Dettagli</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-proposals" class="tab-content">

            <!-- Toolbar -->
            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;"
                th:if="${isOrganizer}">
                <button type="button"
                    onclick="document.getElementById('global-proposal-form').style.display = document.getElementById('global-proposal-form').style.display === 'none' ? 'block' : 'none'"
                    class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    style="width: 100%; text-align: center;" th:text="#{event.proposals.add}">
                    Aggiungi Proposta
                </button>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; width: 100%;"
                    th:if="${!rankedProposals.empty}">
                    <button type="button"
                        class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                        style="width: 100%; text-align: center;" onclick="openBatchAddModal()"
                        th:text="#{proposals.add_all_modal}">
                        Aggiungi Selezionati a Evento
                    </button>
                    <button type="button"
                        class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                        style="width: 100%; text-align: center;"
                        onclick="document.getElementById('smart-events-form').submit()"
                        th:text="#{dashboard.create_smart}">
                        Crea Evento con Selezionati
                    </button>
                </div>
            </div>

            <div id="global-proposal-form"
                class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
                th:if="${isOrganizer}" style="display: none; margin-bottom: 1rem; border: 1px dashed var(--border);">
                <form th:action="@{/proposals/add}" method="post">
                    <div style="margin-bottom: 1rem;">
                        <label for="gp-location" th:text="#{event.location}"
                            style="display:block; margin-bottom: 0.25rem;">Luogo</label>
                        <input type="text" id="gp-location" name="location" style="width: 100%; padding: 0.5rem;"
                            required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="gp-address" th:text="#{event.address}"
                            style="display:block; margin-bottom: 0.25rem;">Indirizzo</label>
                        <input type="text" id="gp-address" name="address" style="width: 100%; padding: 0.5rem;"
                            required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="gp-description" th:text="#{dashboard.description}"
                            style="display:block; margin-bottom: 0.25rem;">Descrizione</label>
                        <input type="text" id="gp-description" name="description" style="width: 100%; padding: 0.5rem;">
                    </div>
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem;" th:text="#{profile.dietary}">Dietary Preferences</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="gp_dietary_OMNIVORE" name="dietaryPreferences" value="OMNIVORE">
                                <label for="gp_dietary_OMNIVORE" style="margin-left: 0.5rem;" th:text="#{register.dietary.OMNIVORE}">Omnivore</label>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="gp_dietary_VEGETARIAN" name="dietaryPreferences" value="VEGETARIAN">
                                <label for="gp_dietary_VEGETARIAN" style="margin-left: 0.5rem;" th:text="#{register.dietary.VEGETARIAN}">Vegetarian</label>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="gp_dietary_VEGAN" name="dietaryPreferences" value="VEGAN">
                                <label for="gp_dietary_VEGAN" style="margin-left: 0.5rem;" th:text="#{register.dietary.VEGAN}">Vegan</label>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <input type="checkbox" id="gp_dietary_CELIAC" name="dietaryPreferences" value="CELIAC">
                                <label for="gp_dietary_CELIAC" style="margin-left: 0.5rem;" th:text="#{register.dietary.CELIAC}">Celiac</label>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit"
                            class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                            th:text="#{app.add}">Aggiungi</button>
                        <button type="button"
                            onclick="document.getElementById('global-proposal-form').style.display='none'"
                            class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                            th:text="#{app.cancel}">Annulla</button>
                    </div>
                </form>
            </div>

            <div th:if="${rankedProposals.empty}"
                class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700">
                <p th:text="#{dashboard.empty_proposals}">Nessuna proposta registrata al momento.</p>
            </div>

            <form id="smart-events-form" th:if="${!rankedProposals.empty}" th:action="@{/events/prepare-smart}"
                method="post">
                <!-- Buttons moved to toolbar -->

                <div th:each="prop : ${rankedProposals}" class="rank-item">
                    <div style="margin-right: 1rem;" th:if="${isOrganizer}">
                        <input type="checkbox" name="selectedProposals" th:value="${prop.encodedData}"
                            th:data-location="${prop.location}" style="width: 20px; height: 20px;">
                    </div>

                    <div class="rank-score">
                        <span th:text="${prop.totalLikes}">0</span>
                        <i style="color: var(--success); font-size: 1rem;">&#9650;</i>
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: bold; font-size: 1.1rem;" th:text="${prop.location}">Location</div>
                        <!-- Dietary Icons -->
                        <div style="display: flex; gap: 0.25rem; margin-bottom: 0.25rem;">
                            <span th:if="${#lists.contains(prop.dietaryPreferences, T(it.ucdm.leisure.dinnerplan.features.user.DietaryPreference).OMNIVORE)}"
                                style="font-size: 1.1rem;" th:title="#{register.dietary.OMNIVORE}">üçñ</span>
                            <span th:if="${#lists.contains(prop.dietaryPreferences, T(it.ucdm.leisure.dinnerplan.features.user.DietaryPreference).VEGETARIAN)}"
                                style="font-size: 1.1rem;" th:title="#{register.dietary.VEGETARIAN}">ü•ó</span>
                            <span th:if="${#lists.contains(prop.dietaryPreferences, T(it.ucdm.leisure.dinnerplan.features.user.DietaryPreference).VEGAN)}"
                                style="font-size: 1.1rem;" th:title="#{register.dietary.VEGAN}">üå±</span>
                            <span th:if="${#lists.contains(prop.dietaryPreferences, T(it.ucdm.leisure.dinnerplan.features.user.DietaryPreference).CELIAC)}"
                                style="font-size: 1.1rem;" th:title="#{register.dietary.CELIAC}">üåæüö´</span>

                            <!-- Edit Dietary Preferences Button -->
                            <button th:if="${isOrganizer}" type="button"
                                style="background: none; border: none; cursor: pointer; font-size: 1rem; margin-left: 0.5rem; color: var(--text-secondary);"
                                th:data-location="${prop.location}" th:data-address="${prop.address}"
                                th:data-preferences="${#strings.listJoin(prop.dietaryPreferences, ',')}"
                                onclick="openUpdateDietaryModal(this)" title="Modifica Preferenze">
                                ‚úèÔ∏è
                            </button>
                        </div>
                        <div style="color: var(--text-secondary);" th:text="${prop.address}">Address</div>
                        <div style="font-size: 0.9rem; margin-top: 0.2rem;" th:text="${prop.description}"></div>

                        <!-- ADD TO EXISTING EVENT BTN -->
                        <div th:if="${isOrganizer}" style="margin-top: 0.5rem;">
                            <button type="button"
                                class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                                style="padding: 2px 8px; font-size: 0.8rem;" th:data-location="${prop.location}"
                                th:data-address="${prop.address}" th:data-description="${prop.description}"
                                onclick="openAddToEventModal(this)" th:text=" '+ ' + #{proposals.add_to_existing}">
                                + Aggiungi a Evento Esistente
                            </button>
                        </div>
                    </div>
                    <div style="text-align: right; min-width: 100px;">
                        <div class="meta"><span th:text="#{dashboard.used}">Usato</span> <span
                                th:text="${prop.usageCount}">0</span> <span th:text="#{dashboard.times}">volte</span>
                        </div>
                        <div class="meta" style="color: var(--error);">
                            <span th:text="${prop.totalDislikes}">0</span> &#9660;
                        </div>
                    </div>
                </div>
            </form>
            </form>
        </div>

        <div id="tab-calendar" class="tab-content">
            <div class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
                style="padding: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <button
                        class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                        onclick="changeMonth(-1)" style="padding: 2px 8px;">&larr;</button>
                    <h4 id="currentMonthLabel" style="margin: 0;">Month Year</h4>
                    <button
                        class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                        onclick="changeMonth(1)" style="padding: 2px 8px;">&rarr;</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                    <!-- Calendar populated by JS -->
                </div>
            </div>
            <!-- Style block removed, using Tailwind classes in JS -->
        </div>
    </div>

    <!-- ADD TO EXISTING EVENT MODAL -->
    <div id="add-to-event-modal"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        th:if="${isOrganizer}"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); border: 1px solid var(--border);">
        <h4 style="margin-bottom: 1rem;" th:text="#{proposals.add_to_event_modal}">Aggiungi Proposta a Evento</h4>
        <form th:action="@{/proposals/add-to-event}" method="post">
            <input type="hidden" id="ate-location" name="location">
            <input type="hidden" id="ate-address" name="address">
            <input type="hidden" id="ate-description" name="description">

            <p><span th:text="#{proposals.adding}">Stai aggiungendo:</span> <strong
                    id="ate-display-loc">Location</strong></p>

            <div class="form-group">
                <label for="ate-eventId" th:text="#{proposals.select_event_label}">Seleziona Evento (Aperto)</label>
                <select id="ate-eventId" name="eventId" class="form-control" required>
                    <option value="" th:text="#{proposals.select_event_default}">-- Seleziona Evento --</option>
                    <option th:each="evt : ${events}"
                        th:if="${evt.status.name() == 'OPEN' and evt.organizer.username == #authentication.name}"
                        th:value="${evt.id}"
                        th:text="${evt.title} + ' (Scad: ' + ${#temporals.format(evt.deadline, 'dd/MM HH:mm')} + ')'">
                        Event Title
                    </option>
                </select>
                <small style="color: var(--text-secondary);" th:text="#{proposals.events_help}">Mostrati solo eventi
                    aperti in cui sei
                    organizzatore.</small>
            </div>

            <div class="form-group">
                <label for="ate-dateOption" th:text="#{proposals.date_option}">Data e Ora Proposta</label>
                <input type="datetime-local" id="ate-dateOption" name="dateOption" required>
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button"
                    class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    onclick="document.getElementById('add-to-event-modal').style.display='none'"
                    th:text="#{app.cancel}">Annulla</button>
                <button type="submit"
                    class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    th:text="#{app.add}">Aggiungi</button>
            </div>
        </form>
    </div>

    <!-- Batch Add To Event Modal -->
    <div id="add-batch-modal"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        th:if="${isOrganizer}"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border);">
        <h4 style="margin-bottom: 1rem;" th:text="#{proposals.add_all_modal}">Aggiungi Selezionati a Evento</h4>

        <form th:action="@{/proposals/add-batch-to-event}" method="post">
            <!-- Hidden inputs container (Reused for logic but mainly using batch-dates-container now) -->
            <div id="batch-hidden-inputs"></div>

            <p style="margin-bottom: 1rem;">Configura le proposte selezionate:</p>

            <div class="form-group">
                <label for="bate-eventId">Seleziona Evento (Aperto)</label>
                <select id="bate-eventId" name="eventId" class="form-control" required>
                    <option value="">-- Seleziona Evento --</option>
                    <option th:each="evt : ${events}"
                        th:if="${evt.status.name() == 'OPEN' and evt.organizer.username == #authentication.name}"
                        th:value="${evt.id}"
                        th:text="${evt.title} + ' (Scad: ' + ${#temporals.format(evt.deadline, 'dd/MM HH:mm')} + ')'">
                        Event Title
                    </option>
                </select>
                <small style="color: var(--text-secondary);">Mostrati solo eventi aperti in cui sei
                    organizzatore.</small>
            </div>

            <!-- Dynamic Date Inputs Container -->
            <div id="batch-dates-container"
                style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--border); padding: 0.5rem; border-radius: 4px;">
                <!-- JS will populate this -->
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button"
                    class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    onclick="document.getElementById('add-batch-modal').style.display='none'">Annulla</button>
                <button type="submit"
                    class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">Aggiungi
                    Tutto</button>
            </div>
        </form>
    </div>

    <!-- Update Dietary Modal -->
    <div id="update-dietary-modal"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); border: 1px solid var(--border);">
        <h4 style="margin-bottom: 1rem;" th:text="#{profile.update_dietary}">Update Dietary</h4>
        <form th:action="@{/proposals/update-dietary}" method="post">
            <input type="hidden" id="ud-location" name="location">
            <input type="hidden" id="ud-address" name="address">

            <div class="form-group" style="margin-bottom: 1rem;">
                <p style="margin-bottom: 0.5rem;"><strong id="ud-display-loc">Location</strong></p>
                <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="ud_dietary_OMNIVORE" name="dietaryPreferences" value="OMNIVORE">
                        <label for="ud_dietary_OMNIVORE" style="margin-left: 0.5rem;" th:text="#{register.dietary.OMNIVORE}">Omnivore</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="ud_dietary_VEGETARIAN" name="dietaryPreferences" value="VEGETARIAN">
                        <label for="ud_dietary_VEGETARIAN" style="margin-left: 0.5rem;" th:text="#{register.dietary.VEGETARIAN}">Vegetarian</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="ud_dietary_VEGAN" name="dietaryPreferences" value="VEGAN">
                        <label for="ud_dietary_VEGAN" style="margin-left: 0.5rem;" th:text="#{register.dietary.VEGAN}">Vegan</label>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="ud_dietary_CELIAC" name="dietaryPreferences" value="CELIAC">
                        <label for="ud_dietary_CELIAC" style="margin-left: 0.5rem;" th:text="#{register.dietary.CELIAC}">Celiac</label>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button"
                    class="btn btn-secondary inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    onclick="document.getElementById('update-dietary-modal').style.display='none'"
                    th:text="#{app.cancel}">Annulla</button>
                <button type="submit"
                    class="btn inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                    th:text="#{app.save}">Salva</button>
            </div>
        </form>
    </div>

    <!-- Error/Success Messages from Flash Attributes -->
    <div th:if="${errorMessage}"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        style="position: fixed; top: 20px; right: 20px; background-color: #fee2e2; color: #991b1b; padding: 1rem; border: 1px solid #f87171; z-index: 3000;">
        <span th:text="${errorMessage}">Error</span>
        <button onclick="this.parentElement.remove()"
            style="margin-left: 10px; border:none; background:none; cursor:pointer;">X</button>
    </div>
    <div th:if="${successMessage}"
        class="card bg-white dark:bg-gray-800 shadow rounded-lg p-4 mb-4 border border-gray-100 dark:border-gray-700"
        style="position: fixed; top: 20px; right: 20px; background-color: #dcfce7; color: #166534; padding: 1rem; border: 1px solid #4ade80; z-index: 3000;">
        <span th:text="${successMessage}">Success</span>
        <button onclick="this.parentElement.remove()"
            style="margin-left: 10px; border:none; background:none; cursor:pointer;">X</button>
    </div>

    <script th:inline="javascript">
        const i18n = {
            daysShort: /*[[#{calendar.days.short}]]*/ 'Dom,Lun,Mar,Mer,Gio,Ven,Sab',
            months: /*[[#{calendar.months}]]*/ 'Gennaio,Febbraio,Marzo,Aprile,Maggio,Giugno,Luglio,Agosto,Settembre,Ottobre,Novembre,Dicembre',
            monthsShort: /*[[#{calendar.months.short}]]*/ 'Gen,Feb,Mar,Mer,Gio,Ven,Sab,Dom'
        };
    </script>
    <script>
        function openAddToEventModal(btn) {
            document.getElementById('ate-location').value = btn.getAttribute('data-location');
            document.getElementById('ate-address').value = btn.getAttribute('data-address');
            document.getElementById('ate-description').value = btn.getAttribute('data-description');
            document.getElementById('ate-display-loc').textContent = btn.getAttribute('data-location');
            document.getElementById('add-to-event-modal').style.display = 'block';
        }

        function openUpdateDietaryModal(btn) {
            document.getElementById('ud-location').value = btn.getAttribute('data-location');
            document.getElementById('ud-address').value = btn.getAttribute('data-address');
            document.getElementById('ud-display-loc').textContent = btn.getAttribute('data-location');

            // Reset checkboxes
            document.querySelectorAll('#update-dietary-modal input[type="checkbox"]').forEach(cb => cb.checked = false);

            // Set current preferences
            const prefs = btn.getAttribute('data-preferences');
            if (prefs) {
                prefs.split(',').forEach(p => {
                    const cb = document.getElementById('ud_dietary_' + p.trim());
                    if (cb) cb.checked = true;
                });
            }

            document.getElementById('update-dietary-modal').style.display = 'block';
        }

        function openBatchAddModal() {
            const checkboxes = document.querySelectorAll('input[name="selectedProposals"]:checked');
            if (checkboxes.length === 0) {
                alert("Seleziona almeno una proposta dalla lista.");
                return;
            }

            const container = document.getElementById('batch-dates-container');
            container.innerHTML = ''; // Clear previous

            checkboxes.forEach(cb => {
                const row = document.createElement('div');
                row.style.marginBottom = '0.75rem';
                row.style.borderBottom = '1px solid var(--border)';
                row.style.paddingBottom = '0.5rem';

                const locName = cb.getAttribute('data-location') || 'Location';

                const label = document.createElement('div');
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '0.25rem';
                label.textContent = locName;
                row.appendChild(label);

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'selectedProposals';
                hiddenInput.value = cb.value;
                row.appendChild(hiddenInput);

                const dateInput = document.createElement('input');
                dateInput.type = 'datetime-local';
                dateInput.name = 'dateOptions';
                dateInput.required = true;
                dateInput.style.width = '100%';
                dateInput.style.padding = '0.25rem';
                row.appendChild(dateInput);

                container.appendChild(row);
            });

            document.getElementById('add-batch-modal').style.display = 'block';
        }

        // Init state
        if (!localStorage.getItem('activeDashboardTab')) {
            localStorage.setItem('activeDashboardTab', 'events');
        }

        function switchTab(tabName) {
            localStorage.setItem('activeDashboardTab', tabName);
            applyTabState();
        }

        function applyTabState() {
            const tabName = localStorage.getItem('activeDashboardTab') || 'events';

            // Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById('btn-' + tabName);
            if (activeBtn) activeBtn.classList.add('active');

            // Content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const activeContent = document.getElementById('tab-' + tabName);
            if (activeContent) activeContent.classList.add('active');
        }

        // Apply on load
        applyTabState();

        // WebSocket
        var socket = new WebSocket(((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/ws");
        var stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            function refreshEventList() {
                fetch('/fragments/dashboard')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('dashboard-content').outerHTML = html;
                        applyTabState(); // Re-apply state after refresh
                        fetchCalendarEvents(); // Also refresh calendar
                    })
                    .catch(console.error);
            }

            stompClient.subscribe('/topic/events', function (message) {
                if (message.body === 'update') {
                    refreshEventList();
                }
            });
            stompClient.subscribe('/user/topic/dashboard-updates', function (message) {
                if (message.body === 'REFRESH') {
                    refreshEventList();
                }
            });
        });

        // Calendar Logic
        let currentCalendarDate = new Date();
        let calendarEvents = [];

        async function fetchCalendarEvents() {
            try {
                const response = await fetch('/api/calendar/events');
                calendarEvents = await response.json();
                renderCalendar();
            } catch (e) {
                console.error("Failed to load calendar events", e);
            }
        }

        // Init Calendar if tab is active
        fetchCalendarEvents();

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;

            grid.innerHTML = '';
            // Tailwind grid is already set on the container in HTML

            const days = i18n.daysShort.split(',');
            days.forEach(d => {
                const h = document.createElement('div');
                h.className = 'text-center font-bold text-xs text-gray-500 dark:text-gray-400 py-1';
                h.innerText = d[0]; // S, M, T...
                grid.appendChild(h);
            });

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            const monthNames = i18n.months.split(','); // Full names for header
            // i18n.months might be full names, let's use what's available

            document.getElementById('currentMonthLabel').innerText =
                new Date(year, month).toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            // PADDING
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const cell = document.createElement('div');
                cell.className = 'border border-gray-200 dark:border-gray-700 rounded p-1 min-h-[60px] bg-white dark:bg-gray-800 relative overflow-hidden flex flex-col gap-0.5';

                // Date Number
                const dateHeader = document.createElement('div');
                dateHeader.innerText = i;
                dateHeader.className = 'font-bold text-xs text-gray-700 dark:text-gray-300 mb-0.5';

                // Check Today
                if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                    cell.classList.add('ring-1', 'ring-primary-500', 'ring-inset');
                    dateHeader.classList.add('text-primary-600', 'dark:text-primary-400');
                }
                cell.appendChild(dateHeader);

                calendarEvents.forEach(evt => {
                    const d = new Date(evt.date);
                    if (d.getFullYear() === year && d.getMonth() === month && d.getDate() === i) {
                        const evtDiv = document.createElement('div');
                        // Styling matches desktop logic but scaled for mobile
                        const baseClasses = 'text-[0.6rem] px-1 py-0.5 rounded truncate cursor-pointer';
                        const colorClasses = evt.type === 'DEADLINE'
                            ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
                            : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';

                        evtDiv.className = `${baseClasses} ${colorClasses}`;
                        evtDiv.innerText = evt.title;
                        evtDiv.title = evt.title;

                        evtDiv.onclick = (e) => {
                            e.stopPropagation();
                            window.location.href = '/events/' + evt.id;
                        };
                        cell.appendChild(evtDiv);
                    }
                });

                grid.appendChild(cell);
            }
        }
    </script>
</section>

</html>