<!DOCTYPE html>
<html th:fragment="layout(title, content)" xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} ?: 'Dinner Plan'">Dinner Plan</title>
    <link rel="stylesheet" th:href="@{/css/fonts.css}">

    <!-- Local Tailwind CSS -->
    <script th:src="@{/js/tailwindcss.js}"></script>
    <script th:src="@{/js/tailwind-config.js}"></script>

    <script th:src="@{/js/stomp.min.js}"></script>
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const theme = savedTheme === 'system' || !savedTheme ? systemTheme : savedTheme;
            document.documentElement.setAttribute('data-theme', theme);
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">
    <div class="container mx-auto p-4 max-w-md">
        <header class="flex flex-col gap-2 p-3 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center">
                <a href="/" class="text-xl font-bold text-primary-600 dark:text-primary-400">DinnerPlan</a>
                <span sec:authorize="isAuthenticated()" class="text-sm text-gray-500 dark:text-gray-400">
                    <span th:text="#{app.welcome(${#authentication.name})}">Ciao, User!</span>
                </span>
            </div>

            <div class="flex justify-between items-center pt-2 border-t border-gray-100 dark:border-gray-700">
                <span sec:authorize="isAuthenticated()" class="flex w-full justify-between items-center gap-3">
                    <div class="flex gap-3">
                        <a th:href="@{/profile}"
                            class="font-medium text-gray-700 dark:text-gray-200 hover:text-primary-600 dark:hover:text-primary-400 py-1"
                            th:text="#{app.profile}">Profilo</a>
                        <a sec:authorize="hasAnyRole('ORGANIZER', 'ADMIN')" th:href="@{/admin/users}"
                            class="font-medium text-gray-700 dark:text-gray-200 hover:text-primary-600 dark:hover:text-primary-400 py-1"
                            th:text="#{app.users}">Utenti</a>
                    </div>

                    <form th:action="@{/logout}" method="post" class="inline m-0">
                        <button type="submit"
                            class="inline-flex items-center px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-full shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none"
                            th:text="#{app.logout}">Esci</button>
                    </form>
                </span>

                <span sec:authorize="!isAuthenticated()" class="flex w-full justify-center gap-4">
                    <a th:href="@{/login}"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-full shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600"
                        th:text="#{app.login}">Accedi</a>
                    <a th:href="@{/register}"
                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-full shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700"
                        th:text="#{app.register}">Registrati</a>
                </span>
            </div>
        </header>

        <main th:replace="${content}">
            <!-- Content goes here -->
        </main>
    </div>

    <footer
        class="text-center p-4 border-t border-gray-200 dark:border-gray-700 mt-8 text-sm text-gray-500 dark:text-gray-400">
        <span th:text="#{app.footer}">&copy; 2025 Dinner Plan</span> |
        <a th:href="@{/manual}"
            class="text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-300"
            th:text="#{app.manual}">Manuale d'Uso</a>

        <div class="mt-4 flex justify-center gap-6 items-center">
            <!-- Theme Switcher -->
            <div class="flex items-center gap-2">
                <label th:text="#{app.theme}">Tema:</label>
                <select id="theme-selector" onchange="switchTheme(this.value)"
                    class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-primary-500 text-xs">
                    <option value="light" th:text="#{theme.light}">‚òÄÔ∏è Light</option>
                    <option value="dark" th:text="#{theme.dark}">üåô Dark</option>
                    <option value="system" th:text="#{theme.system}">üíª System</option>
                </select>
            </div>

            <!-- Language Switcher -->
            <form action="" method="get" class="inline m-0">
                <select name="lang" onchange="this.form.submit()"
                    class="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-primary-500 text-xs">
                    <option value="it" th:selected="${#locale.language == 'it'}">Italiano</option>
                    <option value="en" th:selected="${#locale.language == 'en'}">English</option>
                    <option value="sv" th:selected="${#locale.language == 'sv'}">Svenska</option>
                </select>
            </form>
        </div>
    </footer>

    <script>
        const themeSelector = document.getElementById('theme-selector');

        // Initialize Selector Value
        const savedTheme = localStorage.getItem('theme') || 'system';
        themeSelector.value = savedTheme;

        function switchTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        }

        function applyTheme(theme) {
            let effectiveTheme = theme;
            if (theme === 'system') {
                effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            document.documentElement.setAttribute('data-theme', effectiveTheme);
            // Also toggle class for Tailwind 'class' mode
            if (effectiveTheme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // Listen for system changes if 'system' is selected
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (localStorage.getItem('theme') === 'system' || !localStorage.getItem('theme')) {
                applyTheme('system');
            }
        });
    </script>
</body>

</html>