<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(#{app.title}, ~{::section})}">
<section>
    <div id="dashboard-content" th:fragment="dashboardContent">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 th:text="#{dashboard.header}">Prossime Cene</h2>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('events')" id="btn-events"
                th:text="#{dashboard.tab.events}">Eventi</button>
            <button class="tab-btn" onclick="switchTab('proposals')" id="btn-proposals"
                th:text="#{dashboard.tab.proposals}">Classifica Proposte</button>
        </div>

        <div id="tab-events" class="tab-content active">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;" th:if="${isOrganizer}">
                <a th:href="@{/events/create}" class="btn" th:text="#{dashboard.create}">Crea Nuovo Evento</a>
            </div>

            <div th:if="${events.empty}" class="card">
                <p th:text="#{dashboard.empty}">Nessun evento pianificato al momento.</p>
            </div>

            <div th:each="event : ${events}" class="card event-item"
                th:styleappend="${event.status.name() == 'OPEN' ? 'border-left: 5px solid var(--success);' : 'border-left: 5px solid var(--error);'}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div class="event-title" th:text="${event.title}">Cena Team</div>
                        <div style="margin-bottom: 0.5rem;" th:text="${event.description}">Descrizione</div>
                        <div class="meta">
                            <span th:text="#{event.by}">Organizzatore:</span> <span
                                th:text="${event.organizer.username}">User</span>
                            | <span th:text="#{event.status}">Stato:</span> <span th:text="${event.status}">OPEN</span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="meta" style="margin-bottom: 0.5rem;">
                            <span th:text="#{event.deadline}">Scadenza:</span> <span
                                th:text="${#temporals.format(event.deadline, 'dd MMM yyyy HH:mm')}">Date</span>
                        </div>
                        <a th:href="@{/events/{id}(id=${event.id})}" class="btn btn-secondary"
                            th:text="#{dashboard.view}">Dettagli</a>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-proposals" class="tab-content">

            <!-- Toolbar -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
                th:if="${isOrganizer}">
                <button type="button"
                    onclick="document.getElementById('global-proposal-form').style.display = document.getElementById('global-proposal-form').style.display === 'none' ? 'block' : 'none'"
                    class="btn btn-secondary" th:text="#{event.proposals.add}">
                    Aggiungi Proposta
                </button>
                <div style="display: flex; gap: 0.5rem;" th:if="${!rankedProposals.empty}">
                    <button type="button" class="btn btn-secondary" onclick="openBatchAddModal()">
                        Aggiungi Selezionati a Evento
                    </button>
                    <button type="button" class="btn" onclick="document.getElementById('smart-events-form').submit()"
                        th:text="#{dashboard.create_smart}">
                        Crea Evento con Selezionati
                    </button>
                </div>
            </div>

            <div id="global-proposal-form" class="card" th:if="${isOrganizer}"
                style="display: none; margin-bottom: 1rem; border: 1px dashed var(--border);">
                <form th:action="@{/proposals/add}" method="post">
                    <div style="margin-bottom: 1rem;">
                        <label for="gp-location" th:text="#{event.location}"
                            style="display:block; margin-bottom: 0.25rem;">Luogo</label>
                        <input type="text" id="gp-location" name="location" style="width: 100%; padding: 0.5rem;"
                            required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="gp-address" th:text="#{event.address}"
                            style="display:block; margin-bottom: 0.25rem;">Indirizzo</label>
                        <input type="text" id="gp-address" name="address" style="width: 100%; padding: 0.5rem;"
                            required>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label for="gp-description" th:text="#{dashboard.description}"
                            style="display:block; margin-bottom: 0.25rem;">Descrizione</label>
                        <input type="text" id="gp-description" name="description" style="width: 100%; padding: 0.5rem;">
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="submit" class="btn" th:text="#{app.add}">Aggiungi</button>
                        <button type="button"
                            onclick="document.getElementById('global-proposal-form').style.display='none'"
                            class="btn btn-secondary" th:text="#{app.cancel}">Annulla</button>
                    </div>
                </form>
            </div>

            <div th:if="${rankedProposals.empty}" class="card">
                <p th:text="#{dashboard.empty_proposals}">Nessuna proposta registrata al momento.</p>
            </div>

            <form id="smart-events-form" th:if="${!rankedProposals.empty}" th:action="@{/events/prepare-smart}"
                method="post">
                <!-- Buttons moved to toolbar -->

                <div th:each="prop : ${rankedProposals}" class="rank-item">
                    <div style="margin-right: 1rem;" th:if="${isOrganizer}">
                        <input type="checkbox" name="selectedProposals" th:value="${prop.encodedData}"
                            th:data-location="${prop.location}" style="width: 20px; height: 20px;">
                    </div>

                    <div class="rank-score">
                        <span th:text="${prop.totalLikes}">0</span>
                        <i style="color: var(--success); font-size: 1rem;">&#9650;</i>
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: bold; font-size: 1.1rem;" th:text="${prop.location}">Location</div>
                        <div style="color: var(--text-secondary);" th:text="${prop.address}">Address</div>
                        <div style="font-size: 0.9rem; margin-top: 0.2rem;" th:text="${prop.description}"></div>

                        <!-- ADD TO EXISTING EVENT BTN -->
                        <div th:if="${isOrganizer}" style="margin-top: 0.5rem;">
                            <button type="button" class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.8rem;"
                                th:data-location="${prop.location}" th:data-address="${prop.address}"
                                th:data-description="${prop.description}" onclick="openAddToEventModal(this)">
                                + Aggiungi a Evento Esistente
                            </button>
                        </div>
                    </div>
                    <div style="text-align: right; min-width: 100px;">
                        <div class="meta"><span th:text="#{dashboard.used}">Usato</span> <span
                                th:text="${prop.usageCount}">0</span> <span th:text="#{dashboard.times}">volte</span>
                        </div>
                        <div class="meta" style="color: var(--error);">
                            <span th:text="${prop.totalDislikes}">0</span> &#9660;
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ADD TO EXISTING EVENT MODAL -->
    <div id="add-to-event-modal" class="card" th:if="${isOrganizer}"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); border: 1px solid var(--border);">
        <h4 style="margin-bottom: 1rem;">Aggiungi Proposta a Evento</h4>
        <form th:action="@{/proposals/add-to-event}" method="post">
            <input type="hidden" id="ate-location" name="location">
            <input type="hidden" id="ate-address" name="address">
            <input type="hidden" id="ate-description" name="description">

            <p>Stai aggiungendo: <strong id="ate-display-loc">Location</strong></p>

            <div class="form-group">
                <label for="ate-eventId">Seleziona Evento (Aperto)</label>
                <select id="ate-eventId" name="eventId" class="form-control" required>
                    <option value="">-- Seleziona Evento --</option>
                    <option th:each="evt : ${events}"
                        th:if="${evt.status.name() == 'OPEN' and evt.organizer.username == #authentication.name}"
                        th:value="${evt.id}"
                        th:text="${evt.title} + ' (Scad: ' + ${#temporals.format(evt.deadline, 'dd/MM HH:mm')} + ')'">
                        Event Title
                    </option>
                </select>
                <small style="color: var(--text-secondary);">Mostrati solo eventi aperti in cui sei
                    organizzatore.</small>
            </div>

            <div class="form-group">
                <label for="ate-dateOption">Data e Ora Proposta</label>
                <input type="datetime-local" id="ate-dateOption" name="dateOption" required>
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('add-to-event-modal').style.display='none'">Annulla</button>
                <button type="submit" class="btn">Aggiungi</button>
            </div>
        </form>
    </div>

    <!-- Batch Add To Event Modal -->
    <div id="add-batch-modal" class="card" th:if="${isOrganizer}"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid var(--border);">
        <h4 style="margin-bottom: 1rem;">Aggiungi Selezionati a Evento</h4>

        <form th:action="@{/proposals/add-batch-to-event}" method="post">
            <!-- Hidden inputs container (Reused for logic but mainly using batch-dates-container now) -->
            <div id="batch-hidden-inputs"></div>

            <p style="margin-bottom: 1rem;">Configura le proposte selezionate:</p>

            <div class="form-group">
                <label for="bate-eventId">Seleziona Evento (Aperto)</label>
                <select id="bate-eventId" name="eventId" class="form-control" required>
                    <option value="">-- Seleziona Evento --</option>
                    <option th:each="evt : ${events}"
                        th:if="${evt.status.name() == 'OPEN' and evt.organizer.username == #authentication.name}"
                        th:value="${evt.id}"
                        th:text="${evt.title} + ' (Scad: ' + ${#temporals.format(evt.deadline, 'dd/MM HH:mm')} + ')'">
                        Event Title
                    </option>
                </select>
                <small style="color: var(--text-secondary);">Mostrati solo eventi aperti in cui sei
                    organizzatore.</small>
            </div>

            <!-- Dynamic Date Inputs Container -->
            <div id="batch-dates-container"
                style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--border); padding: 0.5rem; border-radius: 4px;">
                <!-- JS will populate this -->
            </div>

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('add-batch-modal').style.display='none'">Annulla</button>
                <button type="submit" class="btn">Aggiungi Tutto</button>
            </div>
        </form>
    </div>

    <!-- Error/Success Messages from Flash Attributes -->
    <div th:if="${errorMessage}" class="card"
        style="position: fixed; top: 20px; right: 20px; background-color: #fee2e2; color: #991b1b; padding: 1rem; border: 1px solid #f87171; z-index: 3000;">
        <span th:text="${errorMessage}">Error</span>
        <button onclick="this.parentElement.remove()"
            style="margin-left: 10px; border:none; background:none; cursor:pointer;">X</button>
    </div>
    <div th:if="${successMessage}" class="card"
        style="position: fixed; top: 20px; right: 20px; background-color: #dcfce7; color: #166534; padding: 1rem; border: 1px solid #4ade80; z-index: 3000;">
        <span th:text="${successMessage}">Success</span>
        <button onclick="this.parentElement.remove()"
            style="margin-left: 10px; border:none; background:none; cursor:pointer;">X</button>
    </div>

    <script>
        function openAddToEventModal(btn) {
            document.getElementById('ate-location').value = btn.getAttribute('data-location');
            document.getElementById('ate-address').value = btn.getAttribute('data-address');
            document.getElementById('ate-description').value = btn.getAttribute('data-description');
            document.getElementById('ate-display-loc').textContent = btn.getAttribute('data-location');
            document.getElementById('add-to-event-modal').style.display = 'block';
        }

        function openBatchAddModal() {
            const checkboxes = document.querySelectorAll('input[name="selectedProposals"]:checked');
            if (checkboxes.length === 0) {
                alert("Seleziona almeno una proposta dalla lista.");
                return;
            }

            const container = document.getElementById('batch-dates-container');
            container.innerHTML = ''; // Clear previous

            checkboxes.forEach(cb => {
                const row = document.createElement('div');
                row.style.marginBottom = '0.75rem';
                row.style.borderBottom = '1px solid var(--border)';
                row.style.paddingBottom = '0.5rem';

                const locName = cb.getAttribute('data-location') || 'Location';

                const label = document.createElement('div');
                label.style.fontWeight = 'bold';
                label.style.marginBottom = '0.25rem';
                label.textContent = locName;
                row.appendChild(label);

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'selectedProposals';
                hiddenInput.value = cb.value;
                row.appendChild(hiddenInput);

                const dateInput = document.createElement('input');
                dateInput.type = 'datetime-local';
                dateInput.name = 'dateOptions';
                dateInput.required = true;
                dateInput.style.width = '100%';
                dateInput.style.padding = '0.25rem';
                row.appendChild(dateInput);

                container.appendChild(row);
            });

            document.getElementById('add-batch-modal').style.display = 'block';
        }

        // Init state
        if (!localStorage.getItem('activeDashboardTab')) {
            localStorage.setItem('activeDashboardTab', 'events');
        }

        function switchTab(tabName) {
            localStorage.setItem('activeDashboardTab', tabName);
            applyTabState();
        }

        function applyTabState() {
            const tabName = localStorage.getItem('activeDashboardTab') || 'events';

            // Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById('btn-' + tabName);
            if (activeBtn) activeBtn.classList.add('active');

            // Content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const activeContent = document.getElementById('tab-' + tabName);
            if (activeContent) activeContent.classList.add('active');
        }

        // Apply on load
        applyTabState();

        // WebSocket
        var socket = new WebSocket(((window.location.protocol === "https:") ? "wss://" : "ws://") + window.location.host + "/ws");
        var stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            function refreshEventList() {
                fetch('/fragments/dashboard')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('dashboard-content').outerHTML = html;
                        applyTabState(); // Re-apply state after refresh
                    })
                    .catch(console.error);
            }

            stompClient.subscribe('/topic/events', function (message) {
                if (message.body === 'update') {
                    refreshEventList();
                }
            });
            stompClient.subscribe('/user/topic/dashboard-updates', function (message) {
                if (message.body === 'REFRESH') {
                    refreshEventList();
                }
            });
        });
    </script>
</section>

</html>