<!DOCTYPE html>
<html th:fragment="layout(title, content)" xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title} ?: 'Dinner Plan'">Dinner Plan</title>

    <!-- Local Tailwind CSS -->
    <script th:src="@{/js/tailwindcss.js}"></script>
    <script th:src="@{/js/tailwind-config.js}"></script>

    <!-- Custom Fonts (Optional, falls back to system) -->
    <link rel="stylesheet" th:href="@{/css/fonts.css}">
    <!-- Keep for now if manual font file exists, or remove if not used -->

    <!-- Stomp for WebSocket -->
    <script th:src="@{/js/stomp.min.js}"></script>

    <script>
        // Theme Logic
        (function () {
            const savedTheme = localStorage.getItem('theme');
            const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            const theme = savedTheme === 'system' || !savedTheme ? systemTheme : savedTheme;
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
</head>

<body
    class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 flex flex-col min-h-screen transition-colors duration-200">

    <!-- Navbar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50 transition-colors duration-200">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="/" class="flex-shrink-0 flex items-center gap-2">
                        <span class="text-xl font-bold text-primary-600 dark:text-primary-400">DinnerPlan</span>
                    </a>
                </div>

                <!-- Desktop Nav -->
                <div class="hidden sm:ml-6 sm:flex sm:items-center sm:space-x-4">
                    <span sec:authorize="isAuthenticated()" class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400"
                            th:text="#{app.welcome(${#authentication.name})}">Welcome</span>

                        <a th:href="@{/profile}"
                            class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            th:text="#{app.profile}">Profile</a>

                        <a sec:authorize="hasAnyRole('ORGANIZER', 'ADMIN')" th:href="@{/admin/users}"
                            class="px-3 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                            th:text="#{app.users}">Users</a>

                        <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin/dashboard}"
                            class="px-3 py-2 rounded-md text-sm font-medium text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-gray-700 transition-colors">Admin</a>

                        <form th:action="@{/logout}" method="post" class="inline">
                            <button type="submit"
                                class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors"
                                th:text="#{app.logout}">Logout</button>
                        </form>
                    </span>

                    <span sec:authorize="!isAuthenticated()" class="space-x-2">
                        <a th:href="@{/login}"
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                            th:text="#{app.login}">Login</a>
                        <a th:href="@{/register}"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none transition-colors"
                            th:text="#{app.register}">Register</a>
                    </span>
                </div>

                <!-- Mobile Menu Button (Simple implementation for now, or just hide extras) -->
                <div class="flex items-center sm:hidden">
                    <a href="/profile" sec:authorize="isAuthenticated()"
                        class="p-2 rounded-md code-text text-gray-600 dark:text-gray-300">
                        <span class="sr-only">Profile</span>
                        <!-- Simple User Icon SVG -->
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 sm:px-6 lg:px-8">
        <div th:replace="${content}">
            <!-- Content -->
        </div>
    </main>

    <!-- Footer -->
    <footer
        class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-auto transition-colors duration-200">
        <div
            class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 flex flex-col sm:flex-row justify-between items-center gap-4">

            <div class="text-sm text-gray-500 dark:text-gray-400 text-center sm:text-left">
                <span th:text="#{app.footer}">&copy; 2025 Dinner Plan</span> |
                <a th:href="@{/manual}" class="text-primary-600 dark:text-primary-400 hover:underline"
                    th:text="#{app.manual}">Manual</a>
            </div>

            <div class="flex items-center space-x-4">
                <!-- Theme Selector -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm text-gray-500 dark:text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </label>
                    <select id="theme-selector" onchange="switchTheme(this.value)"
                        class="form-select block w-full pl-3 pr-10 py-1 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md shadow-sm">
                        <option value="light" th:text="#{theme.light}">Light</option>
                        <option value="dark" th:text="#{theme.dark}">Dark</option>
                        <option value="system" th:text="#{theme.system}">System</option>
                    </select>
                </div>

                <!-- Language Selector -->
                <form action="" method="get" class="m-0">
                    <select name="lang" onchange="this.form.submit()"
                        class="form-select block w-full pl-3 pr-10 py-1 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md shadow-sm">
                        <option value="it" th:selected="${#locale.language == 'it'}">IT</option>
                        <option value="en" th:selected="${#locale.language == 'en'}">EN</option>
                        <option value="sv" th:selected="${#locale.language == 'sv'}">SV</option>
                    </select>
                </form>
            </div>
        </div>
    </footer>

    <script>
        const themeSelector = document.getElementById('theme-selector');

        // Initialize
        const savedTheme = localStorage.getItem('theme') || 'system';
        themeSelector.value = savedTheme;

        function switchTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
        }

        function applyTheme(theme) {
            if (theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // System preference listener
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (localStorage.getItem('theme') === 'system') {
                applyTheme('system');
            }
        });
    </script>
</body>

</html>